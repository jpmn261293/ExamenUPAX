CREATE OR REPLACE PACKAGE SCHEMPLOYEES.PAEMPLOYEES IS
	TYPE  tipoCursor     IS REF CURSOR;
	csg_Pragma20991 CONSTANT NUMBER := -20991;
	PROCEDURE SPADDEMPLOYEE(
	GENDERID IN NUMBER,
	JOBID IN NUMBER,
	NAME IN VARCHAR2,
	LASTNAME IN VARCHAR2,
	BIRTHDATE IN VARCHAR2,
	EMPLOYEEID OUT NUMBER,
	RPS OUT VARCHAR2,
	MSG OUT VARCHAR2);

	PROCEDURE SPFINDEMPBYJOB(
	JOBID IN NUMBER,
	CURDATOS OUT SYS_REFCURSOR);

END;
/
CREATE OR REPLACE PACKAGE BODY SCHEMPLOYEES.PAEMPLOYEES IS
	PROCEDURE SPADDEMPLOYEE(
	GENDERID IN NUMBER,
	JOBID IN NUMBER,
	NAME IN VARCHAR2,
	LASTNAME IN VARCHAR2,
	BIRTHDATE IN VARCHAR2,
	EMPLOYEEID OUT NUMBER,
	RPS OUT VARCHAR2,
	MSG OUT VARCHAR2) IS
	exc_ErrFoundEmp EXCEPTION;
	PRAGMA EXCEPTION_INIT (exc_ErrFoundEmp, -20991);
	csg_MsjFoundEmp VARCHAR2(30 CHAR) := 'El empleado ya existe.';
	CDATE DATE;
	MSGERR VARCHAR2(255);
	VLEXISTEMP NUMBER;
	VLEXISTJOB NUMBER;
	BEGIN
		BEGIN
			SELECT 1 INTO VLEXISTJOB FROM SCHEMPLOYEES.JOBS j 
			WHERE FIJOBID = JOBID;
		EXCEPTION
		WHEN NO_DATA_FOUND THEN
			VLEXISTJOB := 0;
		END;
		BEGIN
			SELECT 0 INTO VLEXISTEMP FROM SCHEMPLOYEES.EMPLOYEES e 
			WHERE FCNAME = NAME AND FCLASTNAME = LASTNAME;
		EXCEPTION
		WHEN NO_DATA_FOUND THEN
			VLEXISTEMP := 1;
		END;
		IF VLEXISTEMP = 1 AND VLEXISTJOB = 1 THEN
			CDATE:=TO_DATE(BIRTHDATE,'YYYY-MM-DD');
			INSERT INTO SCHEMPLOYEES.EMPLOYEES (FIGENDERID, FIJOBID, FCNAME, FCLASTNAME, FDBIRTHDATE)
			VALUES(GENDERID, JOBID, NAME, LASTNAME, CDATE) RETURNING FIEMPLOYEESID INTO EMPLOYEEID;
			COMMIT;
			RPS := 'TRUE';
		ELSE
			RAISE_APPLICATION_ERROR(csg_Pragma20991, csg_MsjFoundEmp);
		END IF;
	EXCEPTION
	WHEN exc_ErrFoundEmp THEN
		RPS := 'FALSE';
		EMPLOYEEID := 0;
		MSGERR := SUBSTR(SQLERRM, 1, 200);
		MSG := MSGERR;
		ROLLBACK;
	WHEN OTHERS THEN
		ROLLBACK;
		RPS := 'FALSE';
		EMPLOYEEID := 0;
		MSGERR := SUBSTR(SQLERRM, 1, 200);
		MSG := MSGERR;
	END;

	PROCEDURE SPFINDEMPBYJOB(
	JOBID IN NUMBER,
	CURDATOS OUT SYS_REFCURSOR) IS
	BEGIN
		OPEN CURDATOS
			FOR SELECT e.FIEMPLOYEESID, e.FCNAME, e.FCLASTNAME, TO_CHAR(e.FDBIRTHDATE,'YYYY-MM-DD'), j.FIJOBID, j.FCNAME, j.FNSALARY, g.FIGENDERID, g.FCNAME 
			FROM SCHEMPLOYEES.EMPLOYEES e
			INNER JOIN SCHEMPLOYEES.JOBS j 
			ON j.FIJOBID = e.FIJOBID 
			INNER JOIN SCHEMPLOYEES.GENDERS g 
			ON g.FIGENDERID = e.FIGENDERID 
			WHERE e.FIJOBID = JOBID;
	END;
END;
